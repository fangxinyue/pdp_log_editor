# RViz 播放控制测试指南

## 播放/暂停功能测试

### 测试步骤

#### 1. 启动 rosbag
```bash
cd /home/fang/catkin_ws
rosbag play test.bag --clock
```

#### 2. 启动 RViz 和插件
```bash
# 新终端
cd /home/fang/catkin_ws
source devel/setup.bash
rosrun rviz rviz
```
- 在 RViz 中添加 "pdp_log_editor/PdpLogEditorPanel" 插件

#### 3. 测试播放控制

##### A. 基本播放/暂停测试
1. **初始状态**: 按钮显示"播放"（绿色）
2. **点击播放**: 
   - 按钮变为"暂停"（橙色）
   - 状态栏显示"恢复播放rosbag"
   - rosbag 开始播放，时间轴开始移动
3. **点击暂停**:
   - 按钮变为"播放"（绿色）
   - 状态栏显示"暂停播放rosbag"
   - rosbag 暂停，时间轴停止移动
4. **再次点击播放**:
   - 按钮变为"暂停"（橙色）
   - 状态栏显示"恢复播放rosbag"
   - rosbag 从暂停位置继续播放

##### B. 停止按钮测试
1. **播放状态下点击停止**:
   - 播放按钮变为"播放"（绿色）
   - 状态栏显示"停止播放rosbag"
   - rosbag 进程优雅退出

##### C. 时间轴拖拽测试
1. **拖拽时间轴**:
   - 状态栏显示"跳转到时间: XXXs"
   - rosbag 跳转到指定时间点
   - 可以从新位置继续播放/暂停

##### D. 速度控制测试
1. **调整播放速度**:
   - 改变速度框数值（0.1x - 5.0x）
   - 状态栏显示"播放速度设置为: XXXx"
   - rosbag 播放速度相应调整

### 改进功能

#### 1. 智能状态同步
- 插件会自动检测 rosbag 进程状态
- 如果 rosbag 进程意外停止，按钮会自动更新为"播放"状态
- 时间进展检测确保按钮状态与实际播放状态同步

#### 2. 多重控制方法
- **主要方法**: 直接向 rosbag 进程发送键盘命令
  - 空格键：播放/暂停切换
  - 's <时间>'：跳转到指定时间
  - 'r <速率>'：设置播放速率
  - 'q'：优雅退出
- **备用方法**: ROS 话题发布
  - `/rosbag/control`
  - `/rosbag/pause`
  - `/rosbag/seek`

#### 3. 错误处理
- 如果 rosbag 进程不存在，命令会静默失败
- 提供多种回退机制确保控制的可靠性

### 预期行为

#### ✅ 正常情况
1. 点击播放 → rosbag 开始播放，时间轴移动
2. 点击暂停 → rosbag 暂停，时间轴停止
3. 再次点击播放 → rosbag 从暂停位置继续
4. 拖拽时间轴 → rosbag 跳转到指定时间
5. 调整速度 → rosbag 播放速度改变

#### ⚠️ 可能的问题
1. **命令延迟**: 系统调用可能有轻微延迟
2. **进程检测**: 某些情况下可能无法正确检测 rosbag 进程状态
3. **权限问题**: 在某些系统上可能需要额外权限访问 `/proc`

#### 🔧 故障排除
1. **控制不起作用**:
   ```bash
   # 检查 rosbag 进程
   pgrep -f "rosbag play"
   
   # 检查 /clock 话题
   rostopic hz /clock
   ```

2. **按钮状态不同步**:
   - 等待几秒钟，插件会自动检测状态
   - 手动点击播放/暂停按钮重新同步

3. **时间跳转不工作**:
   - 确保 rosbag 以 `--clock` 参数运行
   - 大文件跳转可能需要更长时间

### 技术说明

控制原理是通过以下方式实现的：

1. **进程通信**: 利用 Linux `/proc` 文件系统向 rosbag 进程的标准输入发送命令
2. **ROS 话题**: 作为备用控制方法
3. **状态检测**: 定期检查进程存在性和时间进展

这种方法比传统的 ROS 服务调用更可靠，因为它直接与 rosbag 的交互式界面通信。
