# PDP日志编辑器 - 完整用户说明书

## 📖 项目概述

PDP日志编辑器是一个基于ROS和RViz的自动驾驶场景标注工具，支持时间轴可视化、手动时间捕获、JSON配置管理等功能。本工具专门用于标注和编辑自动驾驶测试场景中的关键时间点。

---

## 🔄 第一步：从Git获取项目

### 1.1 克隆仓库
```bash
# 进入您的catkin工作空间
cd ~/catkin_ws/src

# 克隆项目仓库
git clone http://gitlab.zhidaoauto.com/fangxinyue/pdp_log_editor.git

# 进入项目目录
cd pdp_log_editor
```

### 1.2 检查项目结构
```bash
# 查看项目文件
ls -la

# 应该看到以下主要文件：
# - README.md                    # 项目主要文档
# - CMakeLists.txt              # CMake构建配置
# - package.xml                 # ROS包配置
# - launch_rviz.sh              # RViz启动脚本
# - src/                        # 源代码目录
# - include/                    # 头文件目录
# - msg/                        # ROS消息定义
# - myconfig.rviz              # RViz配置文件
```

---

## 🛠️ 第二步：编译和安装

### 2.1 环境检查
```bash
# 确保ROS环境正确
source /opt/ros/noetic/setup.bash

# 检查依赖
rosdep check pdp_log_editor

# 如果有缺失依赖，安装它们
rosdep install --from-paths . --ignore-src -r -y
```

### 2.2 编译项目
```bash
# 回到catkin工作空间根目录
cd ~/catkin_ws

# 编译项目
catkin_make

# 或者只编译这个包
catkin_make --pkg pdp_log_editor

# 设置环境变量
source devel/setup.bash
```

### 2.3 验证编译结果
```bash
# 检查编译产物
ls devel/lib/libpdp_log_editor.so

# 检查插件是否注册
rospack plugins --attrib=plugin rviz
```

---

## 🚀 第三步：启动插件

### 3.1 使用便捷启动脚本（推荐）
```bash
# 进入项目目录
cd ~/catkin_ws/src/pdp_log_editor

# 启动RViz和插件（自动处理环境和错误）
./launch_rviz.sh
```

### 3.2 手动启动方式
```bash
# 启动roscore（如果未运行）
roscore &

# 手动启动RViz
source ~/catkin_ws/devel/setup.bash
rviz -d ~/catkin_ws/src/pdp_log_editor/myconfig.rviz
```

### 3.3 在RViz中加载插件
1. **添加面板**：
   - 菜单 → `Panels` → `Add New Panel`
   - 选择 `pdp_log_editor/PdpLogEditorPanel`
   - 面板将出现在RViz界面右侧

2. **激活工具**：
   - 菜单 → `Tools` → 选择 `PDP Log Editor Tool`
   - 工具激活后可以进行3D点击标注

---

## 📋 第四步：基本使用流程

### 4.1 标准工作流程

#### 步骤1：加载JSON配置
```
1. 点击面板中的 "Load from JSON" 按钮
2. 选择现有的JSON配置文件（或创建新的）
3. 系统自动加载时间参数并设置时间轴范围
4. 所有功能按钮变为可用状态
```

#### 步骤2：准备Rosbag环境
```bash
# 启动rosbag播放（必须包含--clock参数）
rosbag play --clock your_bag_file.bag

# 或者暂停模式启动
rosbag play --clock --pause your_bag_file.bag
```

#### 步骤3：时间标注
有三种方式进行时间标注：

**方式1：手动时间捕获**
```
1. 点击 "手动获取时间 (0/2)" 按钮
2. 第一次点击 → 捕获takeover（控车）时间
3. 第二次点击 → 捕获event（事件）时间
4. 按钮显示 "手动获取完成 (2/2)"
```

**方式2：直接编辑数值**
```
1. 在彩色时间输入框中直接输入时间值
2. start_time（绿色）：场景开始时间
3. takeover（黄色）：控车时间
4. event（橙色）：事件时间  
5. end_time（红色）：场景结束时间
6. vehicle_config（灰色）：车辆配置信息
```

**方式3：时间轴交互**
```
1. 拖动时间轴进度条跳转到目标时间
2. 点击时间轴上的彩色菱形标记进行调整
3. 拖拽彩色标记到新的时间位置
```

#### 步骤4：保存结果
```
1. 点击 "Save to JSON" 按钮
2. 选择保存位置和文件名
3. 系统保存完整的JSON配置文件
```

### 4.2 高级功能

#### 撤销和重置
- **撤销上一步**：撤销最近的手动时间捕获
- **全部重置**：清空所有手动捕获的时间（保留start_time和end_time）

#### 时间轴同步
- **自动同步**：与rosbag的`/clock`话题实时同步
- **时间跳转**：拖动进度条可控制rosbag播放进度
- **实时显示**：蓝色垂直线显示当前播放位置

---

## 📄 第五步：JSON文件格式

### 5.1 标准JSON结构
```json
{
  "case_time": {
    "start_time": 1234567890.123456,
    "takeover": 1234567895.234567,
    "event": 1234567900.345678,
    "end_time": 1234567905.456789
  },
  "vehicle_config": "JLBJA47708D",
  "case_info": {
    "ego_initial": {
      "position": {"x": -4164.322722157463, "y": 0.0, "z": 488.3309675815399},
      "rotation": {"x": 0.0, "y": 250.71370161918355, "z": 0.0}
    },
    "ego_dest": {"x": -4229.899380000308, "y": 0.0, "z": 183.6990550000337},
    "scene": "environment_GuoZhan"
  },
  "db.sqlite": "https://autocar-mogosim-1255510688.cos.ap-beijing.myqcloud.com/hadmap/bj-V2.9.8.sqlite"
}
```

### 5.2 字段说明
| 字段 | 类型 | 说明 | 示例 |
|------|------|------|------|
| case_time.start_time | number | 场景开始时间戳 | 1234567890.123456 |
| case_time.takeover | number | 控车时间戳 | 1234567895.234567 |
| case_time.event | number | 事件时间戳 | 1234567900.345678 |
| case_time.end_time | number | 场景结束时间戳 | 1234567905.456789 |
| vehicle_config | string | 车辆配置标识 | "JLBJA47708D" |
| case_info | object | 场景信息（位置、旋转等） | 见上方示例 |

---

## 🔧 故障排除

### 6.1 常见问题及解决方案

#### 问题1：插件无法加载
```bash
# 解决方案
cd ~/catkin_ws
catkin_make clean
catkin_make
source devel/setup.bash
```

#### 问题2：时间跳转不工作
```bash
# 检查rosbag是否运行
pgrep -f "rosbag play"

# 确保rosbag使用--clock参数
rosbag play --clock your_file.bag
```

#### 问题3：无法捕获仿真时间
```bash
# 检查/clock话题
rostopic list | grep clock
rostopic echo /clock
```

#### 问题4：RViz启动警告
```bash
# 使用项目提供的启动脚本（已处理警告过滤）
cd ~/catkin_ws/src/pdp_log_editor
./launch_rviz.sh
```

### 6.2 调试命令
```bash
# 检查ROS环境
env | grep ROS

# 查看可用话题
rostopic list

# 监控关键话题
rostopic echo /pdp_log_editor/annotation_result

# 查看插件日志
rosrun rqt_console rqt_console
```

---

## 💡 使用技巧

### 7.1 工作流程建议
1. **准备阶段**：先准备好rosbag文件和基础JSON配置
2. **环境检查**：确保roscore和rosbag正常运行
3. **标注顺序**：建议按 start_time → takeover → event → end_time 顺序标注
4. **定期保存**：完成重要标注后及时保存JSON文件

### 7.2 时间精度注意事项
- 支持微秒级精度（小数点后6位）
- 手动输入时间时注意数值范围的合理性
- 时间轴操作提供可视化反馈，便于精确调整

### 7.3 多场景处理
- 可以为不同场景创建不同的JSON配置文件
- 使用有意义的文件名进行区分
- 建议建立配置文件的版本管理

---

## 📞 技术支持

### 系统要求
- **操作系统**：Ubuntu 20.04
- **ROS版本**：ROS Noetic
- **编译器**：GCC 9+
- **依赖库**：Qt5, nlohmann/json

### 获取帮助
- **项目文档**：查看README.md和其他文档文件
- **问题解决**：参考RViz启动问题解决说明.md
- **源码参考**：查看src/目录下的源代码

---

**版本信息**：v1.0  
**最后更新**：2025年8月12日  
**维护团队**：自动驾驶团队

🎉 现在您可以开始使用PDP日志编辑器进行自动驾驶场景标注了！
