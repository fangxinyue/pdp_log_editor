# PDP Log Editor RViz 插件使用说明书

## 1. 简介

本插件是为 ROS (Robot Operating System) 中的可视化工具 RViz 设计的一个扩展面板。它旨在帮助用户方便地对 `rosbag` 文件进行时间点标注，并提供对 `rosbag` 播放的交互式控制。

主要应用场景是对仿真或真实世界日志数据中的关键时刻进行标记，例如：场景开始、人为控车、关键事件发生、场景结束等。

### 核心功能

- **四点时间戳标注**: 快速标记“场景开始”、“控车”、“事件”和“场景结束”四个关键时间点。
- **可视化时间轴**: 直观地展示 `rosbag` 的总时长、当前播放进度以及所有标注点。
- **文件持久化**: 支持将标注结果保存为 JSON 文件，并能从文件中加载，方便数据迁移和复用。
- **远程控制**: 通过ROS参数 `/sim_pause` 控制 `rosbag` 的暂停与恢复。
- **时间轴同步**: 能够加载 `rosbag` 文件的元数据，使时间轴的范围与 `rosbag` 的实际起止时间完全匹配。

---

## 2. 环境要求与安装

### 环境要求

- **操作系统**: Ubuntu 18.04 或 20.04
- **ROS 版本**: ROS Melodic 或 **Noetic**
- **依赖**: `nlohmann-json` (通常需要手动安装 `sudo apt-get install nlohmann-json3-dev`)

### 安装与编译

1.  将 `pdp_log_editor` 功能包放置在您的 Catkin 工作空间（例如 `~/catkin_ws/src`）下。
2.  返回到工作空间根目录（`~/catkin_ws`）。
3.  执行编译命令：
    ```bash
    catkin_make
    ```
4.  编译成功后，记得 `source` 您的工作空间：
    ```bash
    source devel/setup.bash
    ```

---

## 3. 使用流程

### 第 1 步：启动核心组件

首先，启动 ROS Master 和 RViz。

```bash
roscore
```

在新终端中启动 RViz:

```bash
rviz
```

### 第 2 步：在 RViz 中添加插件面板

1.  在 RViz 的顶部菜单栏中，选择 `Panels` -> `Add New Panel`。
2.  在弹出的窗口中，找到并选择 `pdp_log_editor/PdpLogEditorPanel`。
3.  点击 `OK`，插件面板将出现在 RViz 界面中。

### 第 3 步：播放 Rosbag

为了使插件能够正确同步时间并实现控制，**必须**在播放 `rosbag` 时附加 `--clock` 参数。

打开一个新终端，执行以下命令：

```bash
rosbag play your_bag_file.bag --clock
```

**参数详解:**

-   `--clock`: 让 `rosbag` 发布仿真时间到 `/clock` 话题。插件依赖此话题来获取时间。
-   如果需要循环播放，可以添加 `-l` 或 `--loop` 参数。

### 第 4 步：加载 Rosbag 信息（可选但推荐）

-   点击 **`从Rosbag加载时间轴`** 按钮，选择您正在播放的 `.bag` 文件。
-   插件会自动读取 `rosbag` 的开始和结束时间，并将时间轴的范围与之同步，为您提供一个完整的全局视图。

### 第 5 步：进行标注

插件提供了多种方式来标注时间点：

1.  **手动捕获**:
    -   播放 `rosbag` 到您想标注的时刻。
    -   点击 **`手动获取时间`** 按钮。每点击一次，会依次捕获“场景开始”、“控车”、“事件”和“场景结束”的时间。按钮上的计数器会同步更新。

2.  **时间轴交互**:
    -   直接在下方的 **时间轴** 上单击，蓝色竖线会立刻跳转到您点击的位置。
    -   将蓝色竖线拖动到目标时刻后，点击时间轴上方的彩色菱形标记（例如“开始”、“控车”），即可将当前时间赋给该标记。

3.  **直接编辑**:
    -   在界面左侧的四个彩色背景的输入框中，直接输入精确的时间戳（秒）。

### 第 6 步：控制 Rosbag 播放

本插件不再提供UI按钮来控制播放，而是通过ROS参数服务器实现远程控制。

-   **暂停播放**:
    ```bash
    rosparam set /sim_pause true
    ```
-   **恢复播放**:
    ```bash
    rosparam set /sim_pause false
    ```
插件会实时监测 `/sim_pause` 参数的变化，并自动向 `rosbag play` 进程发送暂停或恢复的指令。

### 第 7 步：保存与发布

-   **`发布标注结果`**: 当四个时间点都标注完成后，点击此按钮会将标注结果以 `pdp_log_editor::PdpLogAnnotation` 消息类型发布到 `/pdp_log_editor/annotation_result` 话题。
-   **`Save to JSON`**: 将当前的标注结果保存到一个 `.json` 文件中。
-   **`Load from JSON`**: 从一个 `.json` 文件中加载之前保存的标注。

---

## 4. UI 界面详解

-   **状态标签 (顶部)**: 显示插件的当前状态、提示信息或错误警告。
-   **时间戳显示框**:
    -   `场景开始` (绿色)
    -   `控车时间` (黄色)
    -   `事件时间` (橙色)
    -   `场景结束` (红色)
-   **主控制按钮**:
    -   `撤销上一步`: 撤销上一次的时间点标注。
    -   `全部重置`: 清空所有已标注的时间点。
    -   `从Rosbag加载时间轴`: 读取 `.bag` 文件，同步时间轴范围。
-   **时间轴 (Timeline)**:
    -   **蓝色竖线**: 指示当前 `rosbag` 的播放时间。
    -   **彩色菱形标记**: 分别对应四个标注时间点在时间轴上的位置。
    -   **进度条**: 可拖动以快速跳转 `rosbag` 播放进度。

---

## 5. 常见问题与解决方案 (FAQ)

**Q1: 无法控制 `rosbag` 暂停/恢复。**

**A:** 确保 `rosbag play` 进程正在运行，并且您使用了正确的 `rosparam` 命令。此功能依赖于向 `rosbag` 进程的 `stdin` 发送空格键，如果 `rosbag` 不是由当前用户启动或权限受限，可能会失败。

**Q2: “使用ROS时间”按钮显示为红色，或时间不更新。**

**A:** 这意味着插件没有接收到来自 `/clock` 话题的仿真时间。
1.  **确认 `--clock` 参数**: 检查 `rosbag play` 命令是否包含了 `--clock` 参数。
2.  **确认 Rosbag 在播放**: 确保 `rosbag play` 进程正在运行。

**Q3: 如何知道插件是否已成功连接到 `rosbag`？**

**A:** 观察 **`使用ROS时间`** 按钮。
-   **蓝色 (Rosbag时间)**: 最佳状态。已连接到 `rosbag` 仿真时间。
-   **红色 (ROS时间)**: 未连接到仿真时间，正在使用您本地计算机的系统时间。
-   **橙色 (普通模式)**: 已连接，但 `rosbag` 未以交互模式 (`-i`) 启动，部分控制功能可能受限。
-   **绿色 (交互模式)**: 已连接，且 `rosbag` 以交互模式启动，所有控制功能可用。


---

## 5. 常见问题与解决方案 (FAQ)

**Q1: Rosbag 播放时时间跳跃严重，播放卡顿。**

**A:** 这是系统性能瓶颈的典型表现，意味着您的计算机处理数据的速度跟不上 `rosbag` 发布的速。
1.  **使用 `--queue` 参数**: 在 `rosbag play` 命令中加入 `--queue=1000` (或更大的值)，可以显著增加缓冲区，平滑播放。
2.  **降低 RViz 负载**: 在 RViz 中，尝试减少点云（PointCloud2）的最大点数、关闭不必要的显示项，以降低渲染压力。
3.  **硬件性能**: 如果以上方法都无效，可能是当前机器性能不足以流畅播放该 `rosbag`。

**Q2: “使用ROS时间”按钮显示为红色，或时间不更新。**

**A:** 这意味着插件没有接收到来自 `/clock` 话题的仿真时间。
1.  **确认 `--clock` 参数**: 检查 `rosbag play` 命令是否包含了 `--clock` 参数。
2.  **确认 Rosbag 在播放**: 确保 `rosbag play` 进程正在运行。

**Q3: 如何知道插件是否已成功连接到 `rosbag`？**

**A:** 观察 **`使用ROS时间`** 按钮。
-   **蓝色 (Rosbag时间)**: 最佳状态。已连接到 `rosbag` 仿真时间。
-   **红色 (ROS时间)**: 未连接到仿真时间，正在使用您本地计算机的系统时间。
